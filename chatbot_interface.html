{% extends "base.html" %}
{% block content %}

<style>
  :root {
    --chat-bg: #0f172a;
    --msg-ai: rgba(255, 255, 255, 0.05);
    --suggestion-bg: #111a2e;
    --btn-primary: #6366f1;
    --btn-secondary: #4f46e5;
  }

  .chat-page-container {
    max-width: 1400px;
    margin: 40px auto;
    padding: 0 20px;
    font-family: 'Inter', sans-serif;
  }

  /* TOP HERO BOX */
  .medibook-hero-card {
    background: #111a2e;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 28px;
    padding: 40px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    margin-bottom: 35px;
  }

  .hero-icon-placeholder {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #818cf8, #6366f1);
    border-radius: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    margin-bottom: 15px;
    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
  }

  .medibook-hero-card h1 {
    font-size: 3.2rem;
    font-weight: 800;
    margin: 0;
    color: white;
  }

  .medibook-hero-card h1 span {
    color: #818cf8;
  }

  .medibook-hero-card p {
    color: #94a3b8;
    font-size: 1.2rem;
    margin: 10px 0 0 0;
  }

  /* GRID LAYOUT */
  .chat-main-grid {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 30px;
    height: 800px;
  }

  /* LEFT: THE CHAT WINDOW */
  .chat-window-card {
    background: #0f172a;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 28px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  /* Chat Header */
  .chat-window-header {
    padding: 20px 30px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.01);
  }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 700;
    font-size: 1rem;
    color: white;
  }

  .green-dot {
    width: 14px;
    height: 14px;
    background: #22c55e;
    border-radius: 50%;
    box-shadow: 0 0 12px #22c55e;
    animation: pulse-dot 2s infinite;
  }

  @keyframes pulse-dot {
    0% {
      transform: scale(1);
      opacity: 1;
    }

    50% {
      transform: scale(1.4);
      opacity: 0.5;
    }

    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .clear-chat-btn {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #cbd5e1;
    padding: 8px 18px;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
  }

  .clear-chat-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }

  /* Chat Messages Area - Ensure it takes full space */
  .chat-messages-scroll {
    flex: 1;
    overflow-y: auto;
    padding: 30px;
    display: flex;
    flex-direction: column;
    gap: 24px;
    scroll-behavior: smooth;
    min-height: 0;
    /* Critical for flex scrolling */
  }

  .chat-messages-scroll::-webkit-scrollbar {
    width: 6px;
  }

  .chat-messages-scroll::-webkit-scrollbar-thumb {
    background: #6366f1;
    border-radius: 10px;
  }

  .message-wrapper {
    display: flex;
    gap: 15px;
    max-width: 85%;
  }

  .message-wrapper.user {
    align-self: flex-end;
    flex-direction: row-reverse;
  }

  .avatar-circle {
    width: 40px;
    height: 40px;
    background: #1e293b;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    flex-shrink: 0;
  }

  .message-bubble {
    padding: 18px 24px;
    border-radius: 20px;
    font-size: 1.1rem;
    line-height: 1.6;
    color: #e2e8f0;
  }

  .ai .message-bubble {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-top-left-radius: 4px;
  }

  .user .message-bubble {
    background: linear-gradient(135deg, #6366f1, #4f46e5);
    color: white;
    border-top-right-radius: 4px;
  }

  .time-info {
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 8px;
  }

  /* SUGGESTION AREA */
  .chat-bottom-area {
    background: #0b1121;
    border-top: 1px solid rgba(255, 255, 255, 0.06);
    padding: 30px;
  }

  .suggestion-chips-grid {
    display: flex;
    flex-wrap: wrap;
    /* Restore grid layout */
    gap: 10px;
    margin-bottom: 20px;
    max-height: 110px;
    /* Prevents covering the screen */
    overflow-y: auto;
    /* Scroll internally if needed */
    padding: 5px;
  }

  .suggestion-chips-grid::-webkit-scrollbar {
    width: 4px;
    /* Thin vertical scrollbar */
  }

  .suggestion-chips-grid::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.4);
    border-radius: 10px;
  }

  .suggestion-chip {
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #94a3b8;
    padding: 12px 20px;
    border-radius: 24px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: 0.2s;
  }

  .suggestion-chip:hover {
    background: rgba(99, 102, 241, 0.15);
    border-color: #6366f1;
    color: white;
    transform: translateY(-2px);
  }

  /* Input panel */
  .input-inner-panel {
    display: flex;
    gap: 15px;
    background: #1e293b;
    padding: 10px;
    border-radius: 18px;
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .input-inner-panel input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: white;
    padding: 12px 20px;
    font-size: 1.15rem;
  }

  .send-msg-btn {
    background: #6366f1;
    color: white;
    border: none;
    padding: 0 30px;
    border-radius: 14px;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    transition: 0.2s;
  }

  .send-msg-btn:hover {
    background: #4f46e5;
    transform: scale(1.02);
  }

  /* RIGHT SIDEBAR */
  .right-sidebar {
    display: flex;
    flex-direction: column;
    gap: 30px;
  }

  .sidebar-widget {
    background: #111a2e;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 28px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .widget-header {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 1.3rem;
    font-weight: 800;
    margin-bottom: 25px;
  }

  .quick-action-btn {
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.06);
    color: white;
    text-decoration: none;
    padding: 18px 25px;
    border-radius: 18px;
    margin-bottom: 15px;
    font-weight: 700;
    font-size: 1.1rem;
    transition: 0.2s;
  }

  .quick-action-btn:hover {
    background: rgba(99, 102, 241, 0.1);
    border-color: #6366f1;
    transform: translateX(8px);
  }

  .emergency-widget {
    border: 1px solid rgba(239, 68, 68, 0.2);
    background: linear-gradient(180deg, rgba(239, 68, 68, 0.05), transparent);
  }

  .emergency-widget p {
    color: #94a3b8;
    line-height: 1.8;
    margin-bottom: 30px;
    font-size: 1.1rem;
  }

  .big-red-btn {
    background: #ef4444;
    color: white;
    text-align: center;
    padding: 24px;
    border-radius: 20px;
    font-weight: 900;
    font-size: 1.8rem;
    text-decoration: none;
    display: block;
    box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
    transition: 0.2s;
  }

  .big-red-btn:hover {
    background: #dc2626;
    transform: translateY(-4px);
  }

  /* MOBILE RESPONSIVE */
  @media (max-width: 1024px) {
    .chat-main-grid {
      grid-template-columns: 1fr;
      height: auto;
    }
  }

  @media (max-width: 768px) {
    .chat-page-container {
      padding: 10px;
      margin: 20px auto;
    }

    .medibook-hero-card h1 {
      font-size: 2.2rem;
    }

    .chat-messages-scroll {
      padding: 15px;
    }
  }
</style>

<div class="chat-page-container">
  <!-- Top Hero -->
  <div class="medibook-hero-card">
    <div class="hero-icon-placeholder">ü§ñ</div>
    <div class="hero-text-content">
      <h1>MediBook <span>AI</span></h1>
      <p>Your personal health assistant is online</p>
    </div>
  </div>

  <div class="chat-main-grid">
    <!-- Chat Window -->
    <div class="chat-window-card">
      <div class="chat-window-header">
        <div class="status-pill">
          <div class="green-dot"></div>
          Active Now
        </div>
        <button class="clear-chat-btn" onclick="location.reload()">Clear Chat</button>
      </div>

      <div id="messages-window" class="chat-messages-scroll">
        <!-- Initial Message -->
        <div class="message-wrapper ai">
          <div class="avatar-circle">ü§ñ</div>
          <div class="msg-content-flex">
            <div class="message-bubble">
              Hello! I'm your healthcare assistant. I can help you with appointment booking, finding doctors, and basic
              medical information. How can I assist you today?
            </div>
            <div class="time-info">Just now</div>
          </div>
        </div>
      </div>

      <div class="chat-bottom-area">
        <!-- Suggestions Area -->
        <div id="quick-suggestions" class="suggestion-chips-grid"></div>

        <!-- Input Panel -->
        <div class="input-inner-panel">
          <input type="text" id="chat-user-input" placeholder="Query about doctors, symptoms, or booking..."
            autocomplete="off">
          <button id="send-btn-action" class="send-msg-btn">Send</button>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
      <div class="sidebar-widget">
        <div class="widget-header">üöÄ Quick Actions</div>
        <a href="/doctors" class="quick-action-btn">
          <span>üë®‚Äç‚öïÔ∏è</span> Browse Doctors
        </a>
        <a href="/dashboard" class="quick-action-btn">
          <span>üìä</span> View Appointments
        </a>
      </div>

      <div class="sidebar-widget emergency-widget">
        <div class="widget-header" style="color: #ef4444;">üö® Emergency?</div>
        <p>If you are experiencing a life-threatening emergency, please do not wait for AI response.</p>
        <a href="tel:911" class="big-red-btn">CALL 911</a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const chatBox = document.getElementById('messages-window');
    const uInput = document.getElementById('chat-user-input');
    const sBtn = document.getElementById('send-btn-action');
    const chipsBox = document.getElementById('quick-suggestions');

    // Populate Suggestions
    fetch('/ai/chat/suggestions')
      .then(res => res.json())
      .then(data => {
        data.suggestions.forEach(s => {
          const chip = document.createElement('div');
          chip.className = 'suggestion-chip';
          chip.textContent = s;
          chip.onclick = () => { uInput.value = s; handleSubmission(); };
          chipsBox.appendChild(chip);
        });
      });

    sBtn.onclick = handleSubmission;
    uInput.onkeypress = (e) => { if (e.key === 'Enter') handleSubmission(); };

    function handleSubmission() {
      const msg = uInput.value.trim();
      if (!msg) return;

      displayMsg(msg, 'user');
      uInput.value = '';

      const loadingId = displayMsg('...', 'ai', true);

      fetch('/ai/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      })
        .then(r => r.json())
        .then(data => {
          const loadingDiv = document.getElementById(loadingId);
          if (loadingDiv) loadingDiv.remove();
          displayMsg(data.response || 'No data found.', 'ai');
        })
        .catch(() => {
          const loadingDiv = document.getElementById(loadingId);
          if (loadingDiv) loadingDiv.remove();
          displayMsg('Server error. Please check connection.', 'ai');
        });
    }

    function displayMsg(html, type, isLoading = false) {
      const id = 'msg-' + Date.now();
      const wrap = document.createElement('div');
      wrap.className = `message-wrapper ${type}`;
      if (isLoading) wrap.id = id;

      const avatar = type === 'ai' ? 'ü§ñ' : 'üë§';

      wrap.innerHTML = `
        <div class="avatar-circle">${avatar}</div>
        <div class="msg-content-flex">
          <div class="message-bubble">${html}</div>
          <div class="time-info">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
        </div>
      `;

      chatBox.appendChild(wrap);
      chatBox.scrollTop = chatBox.scrollHeight;
      return id;
    }

    uInput.focus();
  });
</script>

{% endblock %}